this.ckan.module("reclinepreview",function(e,i){return{options:{i18n:{errorLoadingPreview:"Could not load preview",errorDataProxy:"DataProxy returned an error",errorDataStore:"DataStore returned an error",previewNotAvailableForDataType:"Preview not available for data type: "},site_url:""},initialize:function(){e.proxyAll(this,/_on/),this.el.ready(this._onReady),L.Icon.Default.imagePath=this.options.site_url+"vendor/leaflet/0.4.4/images"},_onReady:function(){this.loadPreviewDialog(preload_resource)},loadPreviewDialog:function(r){function a(e){e=e||i("error loading preview"),window.parent.ckan.pubsub.publish("data-viewer-error",e)}var t=this;if(recline.Backend.DataProxy.timeout=1e4,recline.Backend.DataProxy.dataproxy_url="//jsonpdataproxy.appspot.com",r.formatNormalized=this.normalizeFormat(r.format),r.url=this.normalizeUrl(r.url),""===r.formatNormalized){var o=r.url.split("/");o=o[o.length-1],o=o.split("?"),o=o[0];var n=o.split(".");n.length>1&&(r.formatNormalized=n[n.length-1])}var l,d;r.datastore_active?(r.backend="ckan",r.endpoint=e("body").data("site-root")+"api",d=new recline.Model.Dataset(r),l=this.options.i18n.errorLoadingPreview+": "+this.options.i18n.errorDataStore,d.fetch().done(function(e){t.initializeDataExplorer(e)}).fail(function(e){e.message&&(l+=" ("+e.message+")"),a(l)})):r.formatNormalized in{csv:"",xls:""}&&(r.format=r.formatNormalized,r.backend="dataproxy",d=new recline.Model.Dataset(r),l=this.options.i18n.errorLoadingPreview+": "+this.options.i18n.errorDataProxy,d.fetch().done(function(i){i.bind("query:fail",function(){e(".data-view-container",t.el).hide(),e(".header",t.el).hide()}),t.initializeDataExplorer(i)}).fail(function(e){e.message&&(l+=" ("+e.message+")"),a(l)}))},initializeDataExplorer:function(e){{var i=[{id:"grid",label:"Grid",view:new recline.View.SlickGrid({model:e})},{id:"graph",label:"Graph",view:new recline.View.Graph({model:e})}],r=[{id:"valueFilter",label:"Filters",view:new recline.View.ValueFilter({model:e})}];new recline.View.MultiView({el:this.el,model:e,views:i,sidebarViews:r,config:{readOnly:!0}})}},normalizeFormat:function(e){var i=e.toLowerCase();return i=i.split("/"),i=i[i.length-1]},normalizeUrl:function(e){return 0===e.indexOf("https")?"http"+e.slice(5):e}}});
